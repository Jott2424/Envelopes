{% import "nav_macros.html" as nav %}
{% extends "base.html" %}

{% block title %}Ledger Overview{% endblock %}

{% block content %}
<div class="home-container">

    <!-- Top right navigation -->
    <div class="header-links">
        {{ nav.ledger_settings(budget_id) }}
        {{ nav.budgets_home(budget_id) }}
        {{ nav.home() }}
        {{ nav.logout() }}
    </div>

    <div class="card">
        <h1>Ledger Overview</h1>

        <!-- Filters -->
        <form method="get" class="filters-form">
            <div class="filters-row">
                <div class="form-group">
                    <label>Year</label>
                    <select name="year" class="form-control select-box" onchange="this.form.submit()">
                        {% for y in range(current_year-5, current_year+1) %}
                            <option value="{{ y }}" {% if y==year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Month</label>
                    <select name="month" class="form-control select-box" onchange="this.form.submit()">
                        {% for m in range(1,13) %}
                            <option value="{{ m }}" {% if m==month %}selected{% endif %}>{{ m }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>

        <!-- Ledger tables -->
        {% for week, env_data in ledger.items() %}
            {% set week_start, week_end = week.split(' - ') %}
            <h3>
                {{ week }}
                {{ nav.ledger_receipts_view(budget_id, week_start, week_end) }}
            </h3>

            {% set sorted_envelopes = envelopes.items()|sort(attribute=1) %}
            {% set ns = namespace(total_credit=0, total_debit=0, total_running=0) %}

            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Total</th>
                        {% for eid, name in sorted_envelopes %}
                            <th>{{ name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {# Deposits Row #}
                    <tr>
                        <td>Deposits</td>
                        {% for eid, name in sorted_envelopes %}
                            {% set ns.total_credit = ns.total_credit + (env_data[eid]['credit'] if eid in env_data else 0) %}
                        {% endfor %}
                        <td>{{ ns.total_credit }}</td>
                        {% for eid, name in sorted_envelopes %}
                            <td>{{ env_data[eid]['credit'] if eid in env_data else 0 }}</td>
                        {% endfor %}
                    </tr>

                    {# Withdrawals Row #}
                    <tr>
                        <td>Withdrawals</td>
                        {% for eid, name in sorted_envelopes %}
                            {% set ns.total_debit = ns.total_debit + (env_data[eid]['debit'] if eid in env_data else 0) %}
                        {% endfor %}
                        <td>{{ ns.total_debit }}</td>
                        {% for eid, name in sorted_envelopes %}
                            <td>{{ env_data[eid]['debit'] if eid in env_data else 0 }}</td>
                        {% endfor %}
                    </tr>

                    {# Running Total Row #}
                    <tr>
                        <td>Running Total</td>
                        {% for eid, name in sorted_envelopes %}
                            {% set ns.total_running = ns.total_running + (env_data[eid]['running_total'] if eid in env_data else 0) %}
                        {% endfor %}
                        <td>{{ ns.total_running }}</td>
                        {% for eid, name in sorted_envelopes %}
                            <td>{{ env_data[eid]['running_total'] if eid in env_data else 0 }}</td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        {% endfor %}
    </div>
</div>
{% endblock %}
