{% import "nav_macros.html" as nav %}
{% block content %}

<h1>Edit Receipt Template</h1>

<div class="container">

    <!-- ========================= -->
    <!-- MAIN EDIT / CREATE FORM -->
    <!-- ========================= -->
    <form method="POST" id="template-form">

        <!-- ========================= -->
        <!-- Receipt-level fields -->
        <!-- ========================= -->

        <h3>Receipt Details</h3>

        <label for="merchant">Merchant</label>
        <input type="text" id="merchant" name="merchant" value="{{ template.merchant }}" required>

        <!-- Only relevant for creating a receipt -->
        <h3>Receipt Date</h3>
        <input type="date" name="receipt_date" value="{{ current_date }}" required>

        <h3>Payment Source</h3>
        <select name="payment_source_id" required>
            <option value="">--Select Payment Source--</option>
            {% for ps in payment_sources %}
                <option value="{{ ps[0] }}"
                        {% if ps[0] == template.fk_payment_sources_id %}selected{% endif %}>
                    {{ ps[1] }}
                </option>
            {% endfor %}
        </select>

        <h3>Transaction Type</h3>
        <select name="debit_or_credit" required>
            <option value="debit" {% if template.debit_or_credit == 'debit' %}selected{% endif %}>
                Debit (Money Out)
            </option>
            <option value="credit" {% if template.debit_or_credit == 'credit' %}selected{% endif %}>
                Credit (Money In)
            </option>
        </select>

        <label>Description</label>
        <input type="text" name="receipt_description" value="{{ template.description }}">

        <hr>

        <!-- ========================= -->
        <!-- Envelope transactions -->
        <!-- ========================= -->

        <h3>Transactions</h3>
        <div id="transactions-container"></div>
        <button type="button" id="add-transaction">+ Add Transaction</button>

        <hr>

        <!-- ========================= -->
        <!-- Template actions -->
        <!-- ========================= -->

        <button type="submit" name="action" value="save_template">
            Save Template
        </button>

        <button type="submit" name="action" value="create_receipt">
            Create Receipt from Template
        </button>

    </form>

    <!-- ========================= -->
    <!-- DELETE TEMPLATE (SEPARATE) -->
    <!-- ========================= -->
    <form method="POST"
          action="{{ url_for('receipt_templates_delete_route',
                             budget_id=budget_id,
                             template_id=template.pk_receipt_templates_id) }}"
          onsubmit="return confirm('Delete this receipt template? This cannot be undone.');"
          style="margin-top:15px;">

        <button type="submit"
                style="background:red; color:white; padding:6px 10px; border:none; cursor:pointer;">
            Delete Template
        </button>
    </form>

</div>

<script>
const envelopeMap = {{ envelope_map | tojson }};
let transactionCount = 0;

// Create transaction rows from template
function createTransactionRow(txn = null) {
    transactionCount += 1;

    const container = document.getElementById("transactions-container");
    const row = document.createElement("div");
    row.classList.add("transaction-row");
    row.style = "border:1px solid #ccc; padding:10px; margin-bottom:10px;";
    row.id = `transaction-${transactionCount}`;

    const envelopeOptions = Object.keys(envelopeMap).map(id => {
        const selected = txn && txn.envelope_id == id ? "selected" : "";
        return `<option value="${id}" ${selected}>${envelopeMap[id].name}</option>`;
    }).join("");

    row.innerHTML = `
        <label>Envelope:</label>
        <select name="transactions[${transactionCount}][envelope_id]"
                onchange="renderFields(${transactionCount}, this.value)"
                required>
            <option value="">--Select Envelope--</option>
            ${envelopeOptions}
        </select>

        <div id="fields-${transactionCount}" style="margin-top:10px;"></div>

        <button type="button"
                class="remove-transaction"
                style="margin-top:5px; background:red; color:white; border:none; padding:4px 6px; cursor:pointer;">
            â€“ Remove
        </button>
    `;

    container.appendChild(row);

    if (txn) {
        renderFields(transactionCount, txn.envelope_id, txn.details);
    }
}

// Render fields for a row
function renderFields(rowNumber, envelopeId, values = null) {
    const fieldDiv = document.getElementById(`fields-${rowNumber}`);
    fieldDiv.innerHTML = "";

    if (!envelopeId || !envelopeMap[envelopeId]) return;

    const fields = envelopeMap[envelopeId].fields;

    // Description first
    const descField = fields.find(f => f.name.toLowerCase() === "description");
    if (descField) {
        const val = values ? values.description : "";
        fieldDiv.innerHTML += `
            <div style="margin-bottom:8px;">
                <label>Description</label>
                <input type="text"
                       name="transactions[${rowNumber}][description]"
                       value="${val}">
            </div>
        `;
    }

    // Other fields
    fields.forEach(field => {
        if (field.name.toLowerCase() === "description") return;

        const inputName = `transactions[${rowNumber}][${field.name}]`;
        const inputType =
            field.type.startsWith("numeric") ? "number" :
            field.type === "date" ? "date" : "text";

        const val = values ? values[field.name] : "";

        fieldDiv.innerHTML += `
            <div style="margin-bottom:8px;">
                <label>
                    ${field.name.charAt(0).toUpperCase() + field.name.slice(1).replace(/_/g, " ")}
                    ${field.required ? "*" : ""}
                </label>
                <input type="${inputType}"
                       name="${inputName}"
                       value="${val}"
                       ${field.required ? "required" : ""}>
            </div>
        `;
    });
}

// Preload template transactions
{% for txn in template_transactions %}
createTransactionRow({{ txn | tojson }});
{% endfor %}

// Add transaction row
document.getElementById("add-transaction")
    .addEventListener("click", () => createTransactionRow());

// Remove transaction row
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("remove-transaction")) {
        const row = e.target.closest(".transaction-row");
        if (row) row.remove();
    }
});
</script>

<div class="btn-group2">
    {{ nav.receipts_home(budget_id) }}
</div>

{% endblock %}
