{% import "nav_macros.html" as nav %}
{% extends "base.html" %}

{% block title %}Edit Receipt{% endblock %}

{% block content %}
<div class="home-container">

    <!-- Top right navigation -->
    <div class="header-links">
        {{ nav.receipts_home(budget_id) }}
        {{ nav.home() }}
        {{ nav.logout() }}
    </div>

    <!-- Main card -->
    <div class="card">
        <h1>Edit Receipt</h1>

        <form method="POST" id="receipt-form">

            <!-- Row: Date + Merchant -->
            <div class="flex-row" style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="form-group" style="flex:1;min-width:0;gap:10px">
                    <label for="transaction_date">Date</label>
                    <input type="date" id="transaction_date" name="transaction_date" class="form-control" value="{{ receipt.transaction_date }}" required>
                </div>
                <div class="form-group" style="flex:1; min-width:0;">
                    <label for="merchant">Merchant</label>
                    <input type="text" id="merchant" name="merchant" class="form-control" value="{{ receipt.merchant }}" required>
                </div>
            </div>

            <!-- Row: Payment Source + Transaction Type -->
            <div class="form-row" style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="form-group" style="flex:1;">
                    <label for="payment_source">Payment Source</label>
                    <select name="payment_source_id" id="payment_source" class="form-control select-box" required>
                        <option value="">--Select Payment Source--</option>
                        {% for ps in payment_sources %}
                            <option value="{{ ps[0] }}" {% if ps[0]==receipt.fk_payment_sources_id %}selected{% endif %}>{{ ps[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="flex:1;">
                    <label for="debit_or_credit">Transaction Type</label>
                    <select name="debit_or_credit" id="debit_or_credit" class="form-control select-box" required>
                        <option value="debit" {% if receipt.debit_or_credit=='debit' %}selected{% endif %}>Debit (Money Out)</option>
                        <option value="credit" {% if receipt.debit_or_credit=='credit' %}selected{% endif %}>Credit (Money In)</option>
                    </select>
                </div>
            </div>

            <!-- Description -->
            <div class="form-group" style="margin-bottom:15px;">
                <label for="receipt_description">Description</label>
                <input type="text" id="receipt_description" name="receipt_description" class="form-control" value="{{ receipt.description }}">
            </div>

            <hr>

            <!-- Envelope Transactions -->
            <h3>Transactions</h3>
            <div id="transactions-container"></div>
            <div class="btn-group" style="margin-bottom:15px;">
                <button type="button" id="add-transaction" class="btn grey-btn">+ Add Transaction</button>
            </div>

            <hr>

            <!-- Save Receipt -->
            <div class="btn-group">
                <button type="submit" class="btn submit-btn">Save Changes</button>
            </div>

        </form>

        <!-- Delete Receipt -->
        <form method="POST"
              action="{{ url_for('receipts_delete_route', budget_id=budget_id, receipt_id=receipt.pk_receipts_id) }}"
              onsubmit="return confirm('Delete this receipt? This cannot be undone.')"
              style="margin-top:10px;">
            <button type="submit" class="btn delete-btn">Delete Receipt</button>
        </form>

    </div>
</div>

<script>
const envelopeMap = {{ envelope_map | tojson }};
let transactionCount = 0;

function createTransactionRow(txn=null) {
    transactionCount++;
    const container = document.getElementById("transactions-container");
    const row = document.createElement("div");
    row.classList.add("transaction-row");
    row.style = "border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:8px;";
    row.id = `transaction-${transactionCount}`;

    const envelopeOptions = Object.keys(envelopeMap).map(id => {
        const selected = txn && txn.envelope_id==id ? "selected" : "";
        return `<option value="${id}" ${selected}>${envelopeMap[id].name}</option>`;
    }).join("");

    row.innerHTML = `
        <div class="transaction-inner" style="text-align:center;">
            <div class="form-group" style="max-width:300px; margin:0 auto 10px auto;">
                <label>Envelope</label>
                <select name="transactions[${transactionCount}][envelope_id]" class="form-control select-box"
                        onchange="renderFields(${transactionCount}, this.value)" required>
                    <option value="">--Select Envelope--</option>
                    ${envelopeOptions}
                </select>

            </div>
            <div id="fields-${transactionCount}" class="fields"></div>
            <div class="btn-group" style="margin-top:5px;">
                <button type="button" class="btn delete-btn remove-transaction">â€“ Remove</button>
            </div>
        </div>
    `;

    container.appendChild(row);

    if(txn){
        renderFields(transactionCount, txn.envelope_id, txn.details);
    }
}

function renderFields(rowNumber, envelopeId, values=null) {
    const fieldDiv = document.getElementById(`fields-${rowNumber}`);
    fieldDiv.innerHTML = "";

    if (!envelopeId || !envelopeMap[envelopeId]) return;

    const fields = envelopeMap[envelopeId].fields;

    fields.forEach(field => {
        const inputName = `transactions[${rowNumber}][${field.name}]`;
        let inputType = field.type.startsWith("numeric") ? "number" : (field.type==="date"?"date":"text");
        let val = values ? values[field.name] : "";
        fieldDiv.innerHTML += `
            <div class="form-group" style="margin-bottom:6px;">
                <label style="font-size:0.9em;">${field.name.charAt(0).toUpperCase()+field.name.slice(1).replace(/_/g," ")}${field.required?" *":""}</label>
                <input type="${inputType}" name="${inputName}" value="${val}" class="form-control" style="font-size:0.9em; padding:4px;" ${field.required?"required":""}>
            </div>
        `;
    });

    fieldDiv.classList.add("fields");
}

// Preload existing transactions
{% for txn in receipt_transactions %}
    createTransactionRow({{ txn | tojson }});
{% endfor %}

// Add transaction row
document.getElementById("add-transaction").addEventListener("click", () => createTransactionRow());

// Remove transaction row
document.addEventListener("click", function(e) {
    if(e.target.classList.contains("remove-transaction")){
        const row = e.target.closest(".transaction-row");
        if(row) row.remove();
    }
});
</script>

<style>
.transaction-row .fields {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}
</style>

{% endblock %}
