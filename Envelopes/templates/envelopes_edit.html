{% import "nav_macros.html" as nav %}
{% extends "base.html" %}

{% block title %}Edit Envelope{% endblock %}

{% block content %}
<div class="home-container">

    <!-- Top right navigation -->
    <div class="header-links">
        {{ nav.envelopes_home(budget_id) }}
        {{ nav.home() }}
        {{ nav.logout() }}
    </div>

    <!-- Main card -->
    <div class="card">
        <h1>Edit Envelope</h1>

        <form method="POST" id="envelope-form">

            <!-- Envelope Name -->
            <div class="form-group">
                <label for="Name">Envelope Name</label>
                <input 
                    id="Name" 
                    name="envelope_name" 
                    type="text"
                    class="form-control"
                    value="{{ envelope_name }}"
                    required
                >
            </div>

            <hr>

            <!-- Always Tracked Fields -->
            <h3>Always Tracked (Automatically)</h3>
            {% for name, type_name in [('Date','Date'), ('Merchant','Text'), ('Amount','Numeric(10,2)'), ('Description','Text')] %}
            <div class="tracker-row disabled">
                <input type="text" value="{{ name }}" disabled>
                <select disabled><option>{{ type_name }}</option></select>
                <label><input type="checkbox" checked disabled> Required</label>
            </div>
            {% endfor %}

            <!-- Hidden system fields -->
            <input type="hidden" name="trackers[]" value="amount">
            <input type="hidden" name="types[]" value="numeric(10,2)">
            <input type="hidden" name="required[]" value="0">
            <input type="hidden" name="trackers[]" value="description">
            <input type="hidden" name="types[]" value="text">
            <input type="hidden" name="required[]" value="0">

            <hr>

            <!-- User-defined fields -->
            <h3>Edit What This Envelope Tracks</h3>
            <p class="form-note">Add, remove, or update fields for this envelope.</p>

            <div id="trackers-container">
                {% for field in fields %}
                <div class="tracker-row" data-id="{{ field.id }}">
                    <input type="text" name="trackers[]" value="{{ field.field_name }}">
                    <select name="types[]">
                        <option value="text" {% if field.field_type == 'text' %}selected{% endif %}>Text</option>
                        <option value="numeric(10,2)" {% if field.field_type == 'numeric(10,2)' %}selected{% endif %}>Numeric(10,2)</option>
                        <option value="date" {% if field.field_type == 'date' %}selected{% endif %}>Date</option>
                    </select>
                    <label>
                        <input type="checkbox" name="required[]" value="{{ loop.index0 }}" {% if field.is_required %}checked{% endif %}>
                        Required
                    </label>
                    <button type="button" class="btn remove-btn">–</button>
                </div>
                {% endfor %}
            </div>

            <div class="btn-group">
                <button type="button" id="add-tracker" class="btn secondary-btn">+ Add Field</button>
                <button type="submit" class="btn submit-btn">Save Changes</button>
            </div>

            {{ nav.envelope_edit_delete(budget_id, envelope_id) }}

        </form>
    </div>
</div>

<script>
let trackerCount = {{ fields|length if fields else 0 }};

// Add new tracker
document.getElementById("add-tracker").addEventListener("click", function() {
    trackerCount++;
    const container = document.getElementById("trackers-container");
    const div = document.createElement("div");
    div.classList.add("tracker-row");
    div.innerHTML = `
        <input type="text" name="trackers[]" placeholder="Field ${trackerCount}">
        <select name="types[]">
            <option value="text">Text</option>
            <option value="numeric(10,2)">Numeric(10,2)</option>
            <option value="date">Date</option>
        </select>
        <label>
            <input type="checkbox" name="required[]" value="${trackerCount - 1}">
            Required
        </label>
        <button type="button" class="btn remove-btn">–</button>
    `;
    container.appendChild(div);
});

// Remove tracker
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("remove-btn")) {
        e.target.closest(".tracker-row").remove();
    }
});
</script>

{% endblock %}
