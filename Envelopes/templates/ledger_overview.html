{% import "nav_macros.html" as nav %}
{% extends "base.html" %}

{% block title %}Ledger Overview{% endblock %}

{% block content %}
<div class="home-container">

    <!-- Top right navigation -->
    <div class="header-links">
        {{ nav.ledger_settings(budget_id) }}
        {{ nav.budgets_home(budget_id) }}
        {{ nav.home() }}
        {{ nav.logout() }}
    </div>

    <div class="card ledger-card">
        <h1>Ledger Overview</h1>

        <!-- Filters -->
        <form method="get" class="filters-form">
            <div class="filters-row">
                <div class="form-group">
                    <label>Year</label>
                    <select name="year" class="form-control select-box" onchange="this.form.submit()">
                        {% for y in range(current_year-5, current_year+1) %}
                            <option value="{{ y }}" {% if y==year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Month</label>
                    <select name="month" class="form-control select-box" onchange="this.form.submit()">
                        {% for m in range(1,13) %}
                            <option value="{{ m }}" {% if m==month %}selected{% endif %}>{{ m }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>

        <!-- Ledger tables -->
        {% for week, env_data in ledger.items() %}
            {% set sorted_envelopes = envelopes.items()|sort(attribute=1) %}
            {% set week_start, week_end = week.split(' - ') %}

            <!-- âœ… RESTORED VIEW BUTTON USING MACRO -->
            <div class="week-header">
                <h3>{{ week }}</h3>
                {{ nav.ledger_receipts_view(budget_id, week_start, week_end) }}
            </div>

            <div class="table-scroll">
                <table class="styled-table ledger-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Total</th>
                            {% for eid, name in sorted_envelopes %}
                                <th>{{ name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>

                        <tr>
                            <td>Deposits</td>
                            <td>{{ env_data["_totals"]["credit"] }}</td>
                            {% for eid, name in sorted_envelopes %}
                                <td>{{ env_data[eid]['credit'] }}</td>
                            {% endfor %}
                        </tr>

                        <tr>
                            <td>Withdrawals</td>
                            <td>{{ env_data["_totals"]["debit"] }}</td>
                            {% for eid, name in sorted_envelopes %}
                                <td>{{ env_data[eid]['debit'] }}</td>
                            {% endfor %}
                        </tr>

                        <tr>
                            <td>Running Total</td>
                            <td style="color: {{ 'green' if env_data['_totals']['running_total'] >= 0 else 'red' }}">
                                {{ env_data["_totals"]["running_total"] }}
                            </td>
                            {% for eid, name in sorted_envelopes %}
                                <td style="color: {{ 'green' if env_data[eid]['running_total'] >= 0 else 'red' }}">
                                    {{ env_data[eid]['running_total'] }}
                                </td>
                            {% endfor %}
                        </tr>

                    </tbody>
                </table>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
